import React, { useState, useEffect } from 'react';
import { Plus, Calendar, Target, Apple, Save, Trash2 } from 'lucide-react';

const SimpleCalorieTracker = () => {
  const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
  const [weight, setWeight] = useState('');
  const [activityCalories, setActivityCalories] = useState('');
  const [foodItems, setFoodItems] = useState([]);
  const [newFoodItem, setNewFoodItem] = useState('');
  const [notes, setNotes] = useState('');

  // × ×ª×•× ×™× ×‘×¡×™×¡×™×™× ××“×•×™×™×§×™× (× ×•×¡×—×ª Katch-McArdle)
  const baseData = {
    bmr: 1808, // BMR ××“×•×™×§ ×œ×¤×™ ××¡×” ×¨×–×”
    currentTdee: 2486, // TDEE × ×•×›×—×™ ××“×•×™×§
    targetTdee: 2732,  // TDEE ×™×¢×“ ×¢× 750 ×¤×¢×™×œ×•×ª
    currentActivity: 504, // ×××•×¦×¢ ×¤×¢×™×œ×•×ª × ×•×›×—×™
    targetActivity: 750,  // ×™×¢×“ ×¤×¢×™×œ×•×ª
    targetDeficit: 500,   // ×’×™×¨×¢×•×Ÿ ××ª×•×›× ×Ÿ
    targetConsumption: 1986, // ×¦×¨×™×›×” ×™×•××™×ª ××ª×•×›× × ×ª
    safeMinimum: 2170,    // ××™× ×™××•× ×‘×˜×•×— (120% ×-BMR)
    bodyFatPercent: 28.4, // ××—×•×– ×©×•××Ÿ × ×•×›×—×™
    leanMass: 66.6        // ××¡×” ×¨×–×”
  };

  // ×—×™×©×•×‘ ×¡×š ×§×œ×•×¨×™×•×ª ××›×™×œ×”
  const totalFoodCalories = foodItems.reduce((sum, item) => sum + (item.calories || 0), 0);
  
  // ×—×™×©×•×‘ ×©×¨×™×¤×” ×›×•×œ×œ×ª ××“×•×™×™×§×ª
  const activityCaloriesNum = parseInt(activityCalories) || 0;
  const totalBurn = baseData.bmr + baseData.currentActivity + activityCaloriesNum;
  
  // ×—×™×©×•×‘ ×’×™×¨×¢×•×Ÿ
  const dailyDeficit = totalBurn - totalFoodCalories;

  // ×”×•×¡×¤×ª ×¤×¨×™×˜ ××–×•×Ÿ
  const addFoodItem = () => {
    if (newFoodItem.trim()) {
      // ×—×™×©×•×‘ ××•×˜×•××˜×™ ×©×œ ×§×œ×•×¨×™×•×ª (×–×” ×¨×§ ×”×¢×¨×›×” - ×”××©×ª××© ×™×›×•×œ ×œ×¢×¨×•×š)
      const estimatedCalories = estimateCalories(newFoodItem);
      
      setFoodItems([...foodItems, {
        id: Date.now(),
        name: newFoodItem,
        calories: estimatedCalories,
        time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
      }]);
      setNewFoodItem('');
    }
  };

  // ×”×¢×¨×›×ª ×§×œ×•×¨×™×•×ª ×‘×¡×™×¡×™×ª
  const estimateCalories = (foodName) => {
    const food = foodName.toLowerCase();
    
    // ×××’×¨ ×§×œ×•×¨×™×•×ª ×‘×¡×™×¡×™
    const calorieDatabase = {
      '×œ×—×': 250, '×—×××”': 150, '×‘×™×¦×”': 70, '×—×œ×‘': 150, '×§×¤×”': 5,
      '×‘× × ×”': 105, '×ª×¤×•×—': 95, '×™×•×’×•×¨×˜': 100, '×’×‘×™× ×”': 100,
      '××•×¨×–': 200, '×¤×¡×˜×”': 220, '×©× ×™×¦×œ': 300, '×¢×•×£': 250,
      '×‘××‘×”': 160, '×©×•×§×•×œ×“': 150, '×¢×•×’×™×•×ª': 50, '××™×¥': 120,
      '×¤×™×¨×”': 100, '×¡×œ×˜': 50, '×¤×¡×˜×¨××”': 100, '×—×•××•×¡': 120
    };

    for (const [key, value] of Object.entries(calorieDatabase)) {
      if (food.includes(key)) {
        return value;
      }
    }
    
    return 100; // ×‘×¨×™×¨×ª ××—×“×œ
  };

  // ××—×™×§×ª ×¤×¨×™×˜
  const removeFoodItem = (id) => {
    setFoodItems(foodItems.filter(item => item.id !== id));
  };

  // ×¢×“×›×•×Ÿ ×§×œ×•×¨×™×•×ª ×¤×¨×™×˜
  const updateItemCalories = (id, newCalories) => {
    setFoodItems(foodItems.map(item => 
      item.id === id ? { ...item, calories: parseInt(newCalories) || 0 } : item
    ));
  };

  // ×™×¦×™×¨×ª ×¡×™×›×•× ×™×•××™
  const generateDailySummary = () => {
    const summary = `×™×•× ${new Date(currentDate).toLocaleDateString('he-IL')}:
${weight ? `××©×§×œ: ${weight} ×§"×’` : ''}
×§×œ×•×¨×™×•×ª ×¤×¢×™×œ×•×ª × ×•×¡×¤×ª: ${activityCalories || 0} (×‘×¡×™×¡: ${baseData.currentActivity})
×©×¨×™×¤×” ×›×•×œ×œ×ª: ${totalBurn.toLocaleString()} ×§×œ×•×¨×™×•×ª
×’×™×¨×¢×•×Ÿ: ${dailyDeficit.toLocaleString()} ×§×œ×•×¨×™×•×ª (×™×¢×“: ${baseData.targetDeficit})
××˜×¨×ª ×¦×¨×™×›×”: ${baseData.targetConsumption} ×§×œ×•×¨×™×•×ª

×¤×™×¨×•×˜ ××›×™×œ×”:
${foodItems.map(item => `${item.time} - ${item.name}: ${item.calories} ×§×œ×•×¨×™×•×ª`).join('\n')}

${notes ? `×”×¢×¨×•×ª: ${notes}` : ''}`;

    navigator.clipboard.writeText(summary);
    alert('×”×¡×™×›×•× ×”×•×¢×ª×§ ×œ×œ×•×—! ğŸ“‹');
  };

  // ×©××™×¨×” ××§×•××™×ª
  const saveDay = () => {
    const dayData = {
      date: currentDate,
      weight,
      activityCalories,
      foodItems,
      totalFoodCalories,
      dailyDeficit,
      notes
    };
    
    localStorage.setItem(`day-${currentDate}`, JSON.stringify(dayData));
    alert('×”×™×•× × ×©××¨! âœ…');
  };

  // ×˜×¢×™× ×ª ×™×•×
  useEffect(() => {
    const savedDay = localStorage.getItem(`day-${currentDate}`);
    if (savedDay) {
      const data = JSON.parse(savedDay);
      setWeight(data.weight || '');
      setActivityCalories(data.activityCalories || '');
      setFoodItems(data.foodItems || []);
      setNotes(data.notes || '');
    } else {
      setWeight('');
      setActivityCalories('');
      setFoodItems([]);
      setNotes('');
    }
  }, [currentDate]);

  return (
    <div className="max-w-md mx-auto p-4 bg-white min-h-screen" dir="rtl">
      {/* ×›×•×ª×¨×ª */}
      <div className="text-center mb-6 bg-blue-50 p-4 rounded-lg">
        <h1 className="text-2xl font-bold text-blue-800">××¢×§×‘ ×§×œ×•×¨×™×•×ª ××™×™×“×™</h1>
        <p className="text-blue-600">ğŸ¾ ××¡×£ ××•×–×Ÿ</p>
      </div>

      {/* ×ª××¨×™×š */}
      <div className="mb-4">
        <div className="flex items-center gap-2 mb-2">
          <Calendar className="w-4 h-4 text-gray-600" />
          <span className="font-medium">×ª××¨×™×š:</span>
        </div>
        <input
          type="date"
          value={currentDate}
          onChange={(e) => setCurrentDate(e.target.value)}
          className="w-full p-2 border rounded-lg"
        />
      </div>

      {/* × ×ª×•× ×™× ×‘×¡×™×¡×™×™× */}
      <div className="grid grid-cols-2 gap-3 mb-4">
        <div>
          <label className="block text-sm font-medium mb-1">××©×§×œ (×§"×’):</label>
          <input
            type="number"
            step="0.1"
            value={weight}
            onChange={(e) => setWeight(e.target.value)}
            className="w-full p-2 border rounded-lg"
            placeholder="93"
          />
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">
            <Apple className="w-4 h-4 inline mr-1" />
            ×§×œ×•×¨×™×•×ª ×¤×¢×™×œ×•×ª × ×•×¡×¤×ª:
          </label>
          <input
            type="number"
            value={activityCalories}
            onChange={(e) => setActivityCalories(e.target.value)}
            className="w-full p-2 border rounded-lg"
            placeholder="0"
          />
          <div className="text-xs text-gray-500 mt-1">
            ×××•×¦×¢ × ×•×›×—×™: {baseData.currentActivity} | ×™×¢×“: {baseData.targetActivity}
          </div>
        </div>
      </div>

      {/* ×××–×Ÿ ×§×œ×•×¨×™ ××™×™×“×™ */}
      <div className="mb-4 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg">
        <div className="grid grid-cols-3 gap-2 text-center text-sm">
          <div>
            <div className="font-bold text-lg text-red-600">{totalFoodCalories}</div>
            <div className="text-gray-600">×¦×¨×™×›×”</div>
          </div>
          <div>
            <div className="font-bold text-lg text-green-600">{totalBurn.toLocaleString()}</div>
            <div className="text-gray-600">×©×¨×™×¤×”</div>
          </div>
          <div>
            <div className="font-bold text-lg text-blue-600">{dailyDeficit.toLocaleString()}</div>
            <div className="text-gray-600">×’×™×¨×¢×•×Ÿ</div>
          </div>
        </div>
        <div className="mt-2 text-center">
          <span className={`font-medium ${dailyDeficit >= baseData.targetDeficit ? 'text-green-600' : 'text-orange-600'}`}>
            {dailyDeficit >= baseData.targetDeficit ? 'âœ… ××¦×•×™×Ÿ! ×’×™×¨×¢×•×Ÿ ×›××ª×•×›× ×Ÿ' : 'âš ï¸ ×¦×¨×™×š ×¢×•×“ ×’×™×¨×¢×•×Ÿ'}
          </span>
          <div className="text-xs text-gray-600 mt-1">
            {totalFoodCalories >= baseData.safeMinimum ? 'âœ… ×¦×¨×™×›×” ×‘×˜×•×—×”' : `âš ï¸ ×¦×¨×™×›×” ××ª×—×ª ×œ×‘×˜×•×— (${baseData.safeMinimum})`}
          </div>
          <div className="text-xs text-blue-600 mt-1">
            ××˜×¨×ª ×¦×¨×™×›×”: {baseData.targetConsumption} ×§×œ×•×¨×™×•×ª
          </div>
        </div>
      </div>

      {/* ×”×•×¡×¤×ª ××–×•×Ÿ */}
      <div className="mb-4">
        <div className="flex gap-2 mb-3">
          <input
            type="text"
            value={newFoodItem}
            onChange={(e) => setNewFoodItem(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && addFoodItem()}
            className="flex-1 p-2 border rounded-lg"
            placeholder="××” ××›×œ×ª? (×œ×—×, ×‘×™×¦×”, ×§×¤×”...)"
          />
          <button
            onClick={addFoodItem}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            <Plus className="w-4 h-4" />
          </button>
        </div>
      </div>

      {/* ×¨×©×™××ª ××–×•×Ÿ */}
      <div className="mb-4">
        <h3 className="font-bold mb-2">××›×œ×ª ×”×™×•×:</h3>
        <div className="space-y-2 max-h-60 overflow-y-auto">
          {foodItems.map(item => (
            <div key={item.id} className="flex items-center gap-2 p-2 bg-gray-50 rounded">
              <span className="text-xs text-gray-500">{item.time}</span>
              <span className="flex-1 text-sm">{item.name}</span>
              <input
                type="number"
                value={item.calories}
                onChange={(e) => updateItemCalories(item.id, e.target.value)}
                className="w-16 px-1 py-1 border rounded text-sm text-center"
              />
              <button
                onClick={() => removeFoodItem(item.id)}
                className="text-red-600 hover:bg-red-50 p-1 rounded"
              >
                <Trash2 className="w-3 h-3" />
              </button>
            </div>
          ))}
        </div>
      </div>

      {/* ×”×¢×¨×•×ª */}
      <div className="mb-4">
        <label className="block text-sm font-medium mb-1">×”×¢×¨×•×ª:</label>
        <textarea
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          className="w-full p-2 border rounded-lg h-16 resize-none text-sm"
          placeholder="××™×š ×”×¨×’×©×ª, ×¤×¢×™×œ×•×ª ××™×•×—×“×ª..."
        />
      </div>

      {/* ×›×¤×ª×•×¨×™× */}
      <div className="space-y-2">
        <button
          onClick={generateDailySummary}
          className="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700"
        >
          ğŸ“‹ ×”×¢×ª×§ ×¡×™×›×•× ×™×•××™
        </button>
        <button
          onClick={saveDay}
          className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700"
        >
          ğŸ’¾ ×©××•×¨ ×™×•×
        </button>
      </div>

      {/* ××˜×¨×” ×™×•××™×ª */}
      <div className="mt-4 text-center text-sm text-gray-600">
        <div className="grid grid-cols-2 gap-2 text-xs">
          <div>BMR: {baseData.bmr} (Katch-McArdle)</div>
          <div>××¡×” ×¨×–×”: {baseData.leanMass} ×§"×’</div>
          <div>×©×•××Ÿ × ×•×›×—×™: {baseData.bodyFatPercent}%</div>
          <div>×™×¢×“ ×¤×¢×™×œ×•×ª: {baseData.targetActivity}</div>
          <div>××˜×¨×ª ×¦×¨×™×›×”: {baseData.targetConsumption}</div>
          <div>×’×™×¨×¢×•×Ÿ ×™×¢×“: {baseData.targetDeficit}</div>
        </div>
      </div>
    </div>
  );
};

export default SimpleCalorieTracker;
