import React, { useState, useEffect } from 'react';
import { Plus, Calendar, Target, Apple, Save, Trash2 } from 'lucide-react';

const SimpleCalorieTracker = () => {
  const [currentDate, setCurrentDate] = useState(new Date().toISOString().split('T')[0]);
  const [weight, setWeight] = useState('');
  const [activityCalories, setActivityCalories] = useState('');
  const [foodItems, setFoodItems] = useState([]);
  const [newFoodItem, setNewFoodItem] = useState('');
  const [notes, setNotes] = useState('');

  // נתונים בסיסיים מדוייקים (נוסחת Katch-McArdle)
  const baseData = {
    bmr: 1808, // BMR מדויק לפי מסה רזה
    currentTdee: 2486, // TDEE נוכחי מדויק
    targetTdee: 2732,  // TDEE יעד עם 750 פעילות
    currentActivity: 504, // ממוצע פעילות נוכחי
    targetActivity: 750,  // יעד פעילות
    targetDeficit: 500,   // גירעון מתוכנן
    targetConsumption: 1986, // צריכה יומית מתוכננת
    safeMinimum: 2170,    // מינימום בטוח (120% מ-BMR)
    bodyFatPercent: 28.4, // אחוז שומן נוכחי
    leanMass: 66.6        // מסה רזה
  };

  // חישוב סך קלוריות אכילה
  const totalFoodCalories = foodItems.reduce((sum, item) => sum + (item.calories || 0), 0);
  
  // חישוב שריפה כוללת מדוייקת
  const activityCaloriesNum = parseInt(activityCalories) || 0;
  const totalBurn = baseData.bmr + baseData.currentActivity + activityCaloriesNum;
  
  // חישוב גירעון
  const dailyDeficit = totalBurn - totalFoodCalories;

  // הוספת פריט מזון
  const addFoodItem = () => {
    if (newFoodItem.trim()) {
      // חישוב אוטומטי של קלוריות (זה רק הערכה - המשתמש יכול לערוך)
      const estimatedCalories = estimateCalories(newFoodItem);
      
      setFoodItems([...foodItems, {
        id: Date.now(),
        name: newFoodItem,
        calories: estimatedCalories,
        time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
      }]);
      setNewFoodItem('');
    }
  };

  // הערכת קלוריות בסיסית
  const estimateCalories = (foodName) => {
    const food = foodName.toLowerCase();
    
    // מאגר קלוריות בסיסי
    const calorieDatabase = {
      'לחם': 250, 'חמאה': 150, 'ביצה': 70, 'חלב': 150, 'קפה': 5,
      'בננה': 105, 'תפוח': 95, 'יוגורט': 100, 'גבינה': 100,
      'אורז': 200, 'פסטה': 220, 'שניצל': 300, 'עוף': 250,
      'במבה': 160, 'שוקולד': 150, 'עוגיות': 50, 'מיץ': 120,
      'פירה': 100, 'סלט': 50, 'פסטרמה': 100, 'חומוס': 120
    };

    for (const [key, value] of Object.entries(calorieDatabase)) {
      if (food.includes(key)) {
        return value;
      }
    }
    
    return 100; // ברירת מחדל
  };

  // מחיקת פריט
  const removeFoodItem = (id) => {
    setFoodItems(foodItems.filter(item => item.id !== id));
  };

  // עדכון קלוריות פריט
  const updateItemCalories = (id, newCalories) => {
    setFoodItems(foodItems.map(item => 
      item.id === id ? { ...item, calories: parseInt(newCalories) || 0 } : item
    ));
  };

  // יצירת סיכום יומי
  const generateDailySummary = () => {
    const summary = `יום ${new Date(currentDate).toLocaleDateString('he-IL')}:
${weight ? `משקל: ${weight} ק"ג` : ''}
קלוריות פעילות נוספת: ${activityCalories || 0} (בסיס: ${baseData.currentActivity})
שריפה כוללת: ${totalBurn.toLocaleString()} קלוריות
גירעון: ${dailyDeficit.toLocaleString()} קלוריות (יעד: ${baseData.targetDeficit})
מטרת צריכה: ${baseData.targetConsumption} קלוריות

פירוט אכילה:
${foodItems.map(item => `${item.time} - ${item.name}: ${item.calories} קלוריות`).join('\n')}

${notes ? `הערות: ${notes}` : ''}`;

    navigator.clipboard.writeText(summary);
    alert('הסיכום הועתק ללוח! 📋');
  };

  // שמירה מקומית
  const saveDay = () => {
    const dayData = {
      date: currentDate,
      weight,
      activityCalories,
      foodItems,
      totalFoodCalories,
      dailyDeficit,
      notes
    };
    
    localStorage.setItem(`day-${currentDate}`, JSON.stringify(dayData));
    alert('היום נשמר! ✅');
  };

  // טעינת יום
  useEffect(() => {
    const savedDay = localStorage.getItem(`day-${currentDate}`);
    if (savedDay) {
      const data = JSON.parse(savedDay);
      setWeight(data.weight || '');
      setActivityCalories(data.activityCalories || '');
      setFoodItems(data.foodItems || []);
      setNotes(data.notes || '');
    } else {
      setWeight('');
      setActivityCalories('');
      setFoodItems([]);
      setNotes('');
    }
  }, [currentDate]);

  return (
    <div className="max-w-md mx-auto p-4 bg-white min-h-screen" dir="rtl">
      {/* כותרת */}
      <div className="text-center mb-6 bg-blue-50 p-4 rounded-lg">
        <h1 className="text-2xl font-bold text-blue-800">מעקב קלוריות מיידי</h1>
        <p className="text-blue-600">🎾 אסף אוזן</p>
      </div>

      {/* תאריך */}
      <div className="mb-4">
        <div className="flex items-center gap-2 mb-2">
          <Calendar className="w-4 h-4 text-gray-600" />
          <span className="font-medium">תאריך:</span>
        </div>
        <input
          type="date"
          value={currentDate}
          onChange={(e) => setCurrentDate(e.target.value)}
          className="w-full p-2 border rounded-lg"
        />
      </div>

      {/* נתונים בסיסיים */}
      <div className="grid grid-cols-2 gap-3 mb-4">
        <div>
          <label className="block text-sm font-medium mb-1">משקל (ק"ג):</label>
          <input
            type="number"
            step="0.1"
            value={weight}
            onChange={(e) => setWeight(e.target.value)}
            className="w-full p-2 border rounded-lg"
            placeholder="93"
          />
        </div>
        <div>
          <label className="block text-sm font-medium mb-1">
            <Apple className="w-4 h-4 inline mr-1" />
            קלוריות פעילות נוספת:
          </label>
          <input
            type="number"
            value={activityCalories}
            onChange={(e) => setActivityCalories(e.target.value)}
            className="w-full p-2 border rounded-lg"
            placeholder="0"
          />
          <div className="text-xs text-gray-500 mt-1">
            ממוצע נוכחי: {baseData.currentActivity} | יעד: {baseData.targetActivity}
          </div>
        </div>
      </div>

      {/* מאזן קלורי מיידי */}
      <div className="mb-4 bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg">
        <div className="grid grid-cols-3 gap-2 text-center text-sm">
          <div>
            <div className="font-bold text-lg text-red-600">{totalFoodCalories}</div>
            <div className="text-gray-600">צריכה</div>
          </div>
          <div>
            <div className="font-bold text-lg text-green-600">{totalBurn.toLocaleString()}</div>
            <div className="text-gray-600">שריפה</div>
          </div>
          <div>
            <div className="font-bold text-lg text-blue-600">{dailyDeficit.toLocaleString()}</div>
            <div className="text-gray-600">גירעון</div>
          </div>
        </div>
        <div className="mt-2 text-center">
          <span className={`font-medium ${dailyDeficit >= baseData.targetDeficit ? 'text-green-600' : 'text-orange-600'}`}>
            {dailyDeficit >= baseData.targetDeficit ? '✅ מצוין! גירעון כמתוכנן' : '⚠️ צריך עוד גירעון'}
          </span>
          <div className="text-xs text-gray-600 mt-1">
            {totalFoodCalories >= baseData.safeMinimum ? '✅ צריכה בטוחה' : `⚠️ צריכה מתחת לבטוח (${baseData.safeMinimum})`}
          </div>
          <div className="text-xs text-blue-600 mt-1">
            מטרת צריכה: {baseData.targetConsumption} קלוריות
          </div>
        </div>
      </div>

      {/* הוספת מזון */}
      <div className="mb-4">
        <div className="flex gap-2 mb-3">
          <input
            type="text"
            value={newFoodItem}
            onChange={(e) => setNewFoodItem(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && addFoodItem()}
            className="flex-1 p-2 border rounded-lg"
            placeholder="מה אכלת? (לחם, ביצה, קפה...)"
          />
          <button
            onClick={addFoodItem}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            <Plus className="w-4 h-4" />
          </button>
        </div>
      </div>

      {/* רשימת מזון */}
      <div className="mb-4">
        <h3 className="font-bold mb-2">אכלת היום:</h3>
        <div className="space-y-2 max-h-60 overflow-y-auto">
          {foodItems.map(item => (
            <div key={item.id} className="flex items-center gap-2 p-2 bg-gray-50 rounded">
              <span className="text-xs text-gray-500">{item.time}</span>
              <span className="flex-1 text-sm">{item.name}</span>
              <input
                type="number"
                value={item.calories}
                onChange={(e) => updateItemCalories(item.id, e.target.value)}
                className="w-16 px-1 py-1 border rounded text-sm text-center"
              />
              <button
                onClick={() => removeFoodItem(item.id)}
                className="text-red-600 hover:bg-red-50 p-1 rounded"
              >
                <Trash2 className="w-3 h-3" />
              </button>
            </div>
          ))}
        </div>
      </div>

      {/* הערות */}
      <div className="mb-4">
        <label className="block text-sm font-medium mb-1">הערות:</label>
        <textarea
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          className="w-full p-2 border rounded-lg h-16 resize-none text-sm"
          placeholder="איך הרגשת, פעילות מיוחדת..."
        />
      </div>

      {/* כפתורים */}
      <div className="space-y-2">
        <button
          onClick={generateDailySummary}
          className="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700"
        >
          📋 העתק סיכום יומי
        </button>
        <button
          onClick={saveDay}
          className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700"
        >
          💾 שמור יום
        </button>
      </div>

      {/* מטרה יומית */}
      <div className="mt-4 text-center text-sm text-gray-600">
        <div className="grid grid-cols-2 gap-2 text-xs">
          <div>BMR: {baseData.bmr} (Katch-McArdle)</div>
          <div>מסה רזה: {baseData.leanMass} ק"ג</div>
          <div>שומן נוכחי: {baseData.bodyFatPercent}%</div>
          <div>יעד פעילות: {baseData.targetActivity}</div>
          <div>מטרת צריכה: {baseData.targetConsumption}</div>
          <div>גירעון יעד: {baseData.targetDeficit}</div>
        </div>
      </div>
    </div>
  );
};

export default SimpleCalorieTracker;
